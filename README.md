Kafkastore
==========

Store kafka events from redis to kafka. These events are both click events
(generated by the [click tracker](https://github.com/adtekio/tracking.clicks))
and in-app events (generated by the
[in-app tracker](https://github.com/adtekio/tracking.inapp)).

The purpose is that, the kafkastore, does the heavy lifting instead of the
trackers:

- [device detection](https://github.com/adtekio/kafkastore/blob/a9e3670011c71fcc669a46e62df95d06683cae79/lib/batch_worker.rb#L34-L37)
- [geoip lookup](https://github.com/adtekio/kafkastore/blob/a9e3670011c71fcc669a46e62df95d06683cae79/lib/batch_worker.rb#L33)
- [event batching](https://github.com/adtekio/kafkastore/blob/a9e3670011c71fcc669a46e62df95d06683cae79/lib/batch_inserter.rb#L25)

SSL Termination and load balancing is left to the trackers.

Kafka Message Format
-----

The [message format](https://github.com/adtekio/kafkastore/blob/a9e3670011c71fcc669a46e62df95d06683cae79/lib/batch_inserter.rb#L17-L21) is very simple for the following reasons:

- to make it easy for a consumer to determine whether it needs to handle
  the event ([path](https://github.com/adtekio/kafkastore/blob/a9e3670011c71fcc669a46e62df95d06683cae79/lib/batch_inserter.rb#L20) is the event type and comes
  first).
- making it simple to [extend the message](https://github.com/adtekio/kafkastore/blob/a9e3670011c71fcc669a46e62df95d06683cae79/lib/batch_worker.rb#L29-L41)
  with more parameters in the future
- clear separation between meta details (i.e. the device and geoip information)
  and the original payload of the tracking event.
- human readable (i.e. string) making debugging that much easier.
- low computation to decode a message (i.e. using CGI encoding instead of JSON)

Of course, the assumption made here is that tracking calls will always be
simple in nature (i.e. not binary values) and the paramters will always be
key/value pairs (i.e. CGI/URL parameters). This might not be the case if post
requests are used for tracking events.

Development
----------

Generate a ```.env``` and then fill it with values:

    prompt> rake appjson:to_dotenv
    prompt> $EDITOR .env

Start the worker and web frontend with:

    prompt> foreman start web
    prompt> foreman start worker

Deployment
----------

[![Deploy To Heroku](https://www.herokucdn.com/deploy/button.png)](https://heroku.com/deploy?template=https://github.com/adtekio/kafkastore)
